# shruggie-indexer — Pending Updates (2026-02-25, Batch 2)

- **Project:** `shruggie-indexer`
- **Repository:** [shruggietech/shruggie-indexer](https://github.com/shruggietech/shruggie-indexer)
- **Author:** William Thompson (ShruggieTech LLC)
- **Date:** 2026-02-25
- **Target Release:** Pre-v0.1.1 (GUI stabilization)
- **Audience:** AI-first, Human-second
- **Predecessor:** This document follows `20260223-002-Updates.md`. It assumes all items in that document have been implemented and merged. The previously planned `20260224-002-Updates.md` is deferred and will be renumbered to `20260225-003-Updates.md` upon execution.

---

## Purpose

This document defines a single comprehensive sprint to stabilize the GUI application before the v0.1.1 release cycle defined in `20260225-003-Updates.md` (formerly `20260224-002-Updates.md`). The work items address broken core operations, a fundamental redesign of the output system, process lifecycle management, and residual ExifTool error handling regressions.

Every item in this document targets `src/shruggie_indexer/gui/app.py` and its immediate support modules. No schema changes, no documentation site work, no release activity. This is a functional correctness and UX pass on the GUI.

This document is the authoritative work order for this sprint. All items are to be executed in a single context window.

### Implementation Ordering

All sections are part of a single sprint but MUST be implemented in the following order due to internal dependencies:

1. **Section 1** (Broken operations) — Fix Rename and Meta Merge Delete. These are correctness failures that must be resolved before the output system can be meaningfully tested.
2. **Section 2** (Output system overhaul) — Redesign the output model, remove dead controls, and implement the new three-mode system. Depends on Section 1 because output validation requires working operations.
3. **Section 3** (Output viewer behavior) — Fix the forced tab-switch on operation completion. Depends on Section 2 because the output system redesign changes how completion events are handled.
4. **Section 4** (ExifTool process cleanup) — Ensure all ExifTool child processes are terminated on application exit. Independent of Sections 1–3 but sequenced here to keep operation-layer fixes grouped before process-lifecycle fixes.
5. **Section 5** (ExifTool warning regression for unknown file types) — Investigate and resolve residual warnings for `.7z` and similar files. Depends on Section 4 because the process cleanup changes may affect ExifTool lifecycle management.

---

## 1. Broken Core Operations: Rename and Meta Merge Delete (Priority: Critical — Execute First)

### 1.1. Problem Statement

Two of the three core operation types are completely non-functional in the GUI. These are not partial failures or edge cases — the operations produce no observable effect whatsoever under any run configuration.

| Operation | Expected behavior | Actual behavior |
|-----------|-------------------|-----------------|
| **Rename** | Files are renamed to their `storage_name` values (§6.10 of the spec). In-place sidecar files are written as reversal manifests. | No files are renamed. No sidecar files are written. No errors are raised. The operation completes silently with no effect. |
| **Meta Merge Delete** | Sidecar metadata is merged into the parent entry's metadata array. Original sidecar files are deleted from disk after merge (§4.1, Stage 6). | No sidecar files are deleted. Merge behavior is unverified but deletion — the distinguishing behavior of this operation — does not occur. |

### 1.2. Required Investigation

The implementing agent must trace the full execution path for both operations from the GUI's START button handler through the backend orchestrator. The likely failure points are:

- The GUI is not passing the correct flags (`rename`, `meta_merge_delete`) to the backend `index_path()` / `build_*_entry()` calls.
- The `IndexerConfig` object constructed by the GUI does not reflect the operation type selected in the UI.
- The `_reconcile_controls()` method is overriding or resetting flags during pre-execution state reconciliation.
- The backend functions receive the flags but the post-processing stages (rename in Stage 6, sidecar deletion in Stage 6) are not being triggered.

The agent MUST NOT guess at the root cause. Read the code, trace the execution path, identify the exact point of failure, and fix it.

### 1.3. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/gui/app.py` | GUI operation dispatch, `IndexerConfig` construction, START handler |
| `src/shruggie_indexer/core/entry.py` | Backend orchestrator — verify flag propagation through `build_file_entry()` and `build_directory_entry()` |
| `src/shruggie_indexer/core/rename.py` | Rename execution — verify it is invoked when `config.rename` is `True` |
| `src/shruggie_indexer/core/sidecar.py` | Sidecar deletion — verify it is invoked when `config.meta_merge_delete` is `True` |

### 1.4. Acceptance Criteria

- **Rename:** When the Rename option is enabled and an Index operation is run against a directory containing files, files are renamed to their `storage_name` values on disk. In-place `_meta2.json` sidecar files are written alongside each renamed file containing the original filename in `name.text`.
- **Meta Merge Delete:** When Meta Merge Delete is selected as the operation type and run against a directory containing files with sidecar metadata files, the sidecar content is merged into the parent entry and the original sidecar files are deleted from disk.
- Both operations produce appropriate log output reflecting the actions taken.
- No regressions in the Index or Meta Merge operations.

---

## 2. Output System Overhaul (Priority: Critical)

### 2.1. Problem Statement

The current output system exposes too many interacting controls (output mode radio buttons, custom output path field, in-place sidecar toggle, dry-run toggle) that create a combinatorial surface area of configurations — many of which produce confusing or broken behavior. The persistent issues around output handling indicate that the current design is not salvageable through incremental fixes.

This section replaces the entire output selection model with a simplified three-mode system that eliminates user-facing output path configuration and uses sensible defaults exclusively.

### 2.2. Controls to Remove

The following controls and their associated state variables, session persistence keys, and `_reconcile_controls()` branches MUST be removed entirely:

| Control | Current location | Reason for removal |
|---------|-----------------|-------------------|
| **"Write in-place sidecar files" checkbox** | Options section, Operations page | Subsumed by the new output modes. In-place behavior is now implicit in "Multi-File Output" mode. |
| **"Dry run (preview only)" checkbox** | Options section, Operations page | Adds complexity without clear value in a GUI context. Users who want to preview results should use "View Only" mode instead. |
| **Output mode radio buttons** (View only / Save to file / Both) | Output section, Operations page | Replaced by the new three-mode selector. |
| **Custom output path field and browse button** | Output section, Operations page | Users no longer specify output paths. All output paths are derived from input paths using the tool's default naming conventions. |

### 2.3. New Output Mode Selector

Replace the existing output controls with a single selector offering three mutually exclusive modes. Only one mode can be active at a time. Each mode overrides the other two.

**Control type:** `CTkComboBox` or `CTkSegmentedButton` — whichever is consistent with the existing operation type selector pattern.

**Modes:**

| Mode | Label | Description |
|------|-------|-------------|
| **Single File Output** | `Single file` | Writes one output file using default naming conventions. No sidecar files. No output viewer. |
| **Multi-File Output** | `Multi-file` | Writes in-place sidecar files AND all relevant `directorymeta2` summary files. A superset of Single File Output. No output viewer. |
| **View Only** | `View only` | Produces the same output as Single File Output but writes to the output viewer panel instead of disk. Nothing is written to disk. |

### 2.4. Mode Availability Matrix

Not all modes are available for all input/operation combinations. The selector must enforce these constraints via `_reconcile_controls()`:

| Input type | Operation | Single File | Multi-File | View Only |
|------------|-----------|:-----------:|:----------:|:---------:|
| Single file | Index | ✓ (default) | ✗ | ✓ |
| Single file | Meta Merge | ✓ (default) | ✗ | ✓ |
| Single file | Meta Merge Delete | ✓ (default) | ✗ | ✗ |
| Directory | Index | ✓ | ✓ (default) | ✓ |
| Directory | Meta Merge | ✓ | ✓ (default) | ✓ |
| Directory | Meta Merge Delete | ✓ | ✓ (default) | ✗ |

**Constraint rules:**

- **Multi-File Output** is only available when the target is a directory. If a single file target is selected and Multi-File was previously chosen, the mode must automatically fall back to Single File Output.
- **View Only** is NOT available when the operation type is Meta Merge Delete. This prevents users from performing a destructive mass-deletion of sidecar files without a persistent output record. If Meta Merge Delete is selected and View Only was previously chosen, the mode must automatically fall back to Single File Output.

### 2.5. Output Naming Conventions

All output paths are derived automatically from the input target path. The user does not configure output paths.

| Input type | Output mode | Output path |
|------------|-------------|-------------|
| Single file (`/path/to/photo.jpg`) | Single File | `/path/to/photo.jpg_meta2.json` |
| Single file | View Only | *(no disk output — displayed in viewer)* |
| Directory (`/path/to/album/`) | Single File | `/path/to/album_directorymeta2.json` |
| Directory | Multi-File | `/path/to/album_directorymeta2.json` + per-file `_meta2.json` sidecars within the directory tree |
| Directory | View Only | *(no disk output — displayed in viewer)* |

### 2.6. Output Path Display Field

The area currently occupied by the output path input field and browse button MUST be converted into a **read-only display field** that shows the computed output path based on the current input target and output mode.

**Behavior by mode:**

| Output mode | Display content |
|-------------|----------------|
| Single File (single file input) | Full path to the `_meta2.json` output file |
| Single File (directory input) | Full path to the `_directorymeta2.json` output file, with a small note beneath: *"Summary output file. No sidecar files will be written."* |
| Multi-File | Full path to the `_directorymeta2.json` output file, with a small note beneath: *"Summary output file. Per-file sidecar files will also be written within the directory tree."* |
| View Only | Greyed-out text: *"Output will be displayed in the viewer panel."* |

The display field updates whenever the input target path or output mode changes. If no input target is set, the field shows placeholder text: *"Select a target to see the output path."*

### 2.7. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/gui/app.py` | Remove old output controls. Add new output mode selector and read-only path display. Update `_reconcile_controls()` with new constraint matrix. Update START handler to route output based on selected mode. Update session persistence to save/restore the new output mode. |

### 2.8. Spec References

| Reference | Section |
|-----------|---------|
| Output display and export | `shruggie-indexer-spec.md` §10.6 |
| Context-sensitive options | `shruggie-indexer-spec.md` §10.3 |
| CLI output flags | `shruggie-indexer-spec.md` §8.3, §8.4 |

### 2.9. Acceptance Criteria

- The old output controls (radio buttons, custom path field, browse button, in-place checkbox, dry-run checkbox) are completely removed from the UI.
- A single output mode selector offers exactly three options: Single File, Multi-File, View Only.
- Multi-File is disabled and unavailable when the target is a single file.
- View Only is disabled and unavailable when the operation is Meta Merge Delete.
- Constraint violations cause the mode to fall back to the appropriate default automatically (no error dialogs).
- The read-only output path display correctly reflects the computed path for the current input/mode combination and updates reactively.
- Single File Output on a single file target writes a `_meta2.json` file alongside the input.
- Single File Output on a directory target writes a `_directorymeta2.json` file alongside the input directory and does NOT write per-file sidecar files.
- Multi-File Output on a directory target writes both the `_directorymeta2.json` summary AND per-file `_meta2.json` sidecar files within the directory tree.
- View Only mode writes nothing to disk. Output is displayed in the output viewer panel.
- The output mode selection persists across GUI sessions via the session file.
- No trace of the removed controls remains in the codebase (no dead variables, no orphaned session keys, no vestigial `_reconcile_controls()` branches).

---

## 3. Output Viewer: Stop Forcing Tab Switch on Completion (Priority: High)

### 3.1. Problem Statement

When an operation completes while the user is viewing the Log tab in the bottom panel, the GUI forcibly switches the active tab to the Output viewer. This is jarring and disruptive — if a user chose to watch the log output during an operation, they should remain on the Log tab until they decide to navigate away.

### 3.2. Required Behavior

- When an operation completes, the GUI MUST NOT automatically switch the active bottom-panel tab.
- If the user is on the Log tab when the operation finishes, they stay on the Log tab.
- If the user is on the Output tab when the operation finishes (and the mode produces viewer output), the output content loads into the Output tab normally.
- When output is available but the user is not currently viewing the Output tab, a subtle visual indicator (e.g., a brief highlight or badge on the "Output" tab label) may be used to signal that new output is ready. This indicator is optional but encouraged — the critical requirement is that the tab does NOT switch.

### 3.3. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/gui/app.py` | Operation completion handler — remove any call that programmatically switches the bottom-panel tab to the Output view on job completion. |

### 3.4. Acceptance Criteria

- Running an operation while the Log tab is active does not switch the view to the Output tab upon completion.
- Output content is still loaded correctly when the user manually navigates to the Output tab after completion.
- No regressions in output display when the user is already on the Output tab during completion.

---

## 4. ExifTool Process Cleanup on Application Exit (Priority: Critical)

### 4.1. Problem Statement

The GUI is leaving orphaned ExifTool processes running in the background after the application is closed. This is a resource leak and a release-blocking defect. Users who run the GUI repeatedly accumulate zombie `exiftool` processes that consume memory and may hold file locks.

The root cause is likely one or both of the following:

- The persistent ExifTool process (managed via `pyexiftool`'s `-stay_open` mode) is not being explicitly terminated during the application's shutdown sequence.
- The application's `WM_DELETE_WINDOW` handler (or equivalent `destroy()` / `on_closing()` method) does not call the ExifTool cleanup function.

### 4.2. Required Behavior

The application MUST guarantee that all child processes — especially the persistent ExifTool process — are terminated when the GUI window is closed. This applies to all exit paths:

| Exit path | Cleanup required |
|-----------|-----------------|
| User clicks the window close button (X) | Yes |
| User presses `Alt+F4` / `Cmd+Q` | Yes |
| Application crashes or receives `SIGTERM` | Best-effort (register `atexit` handler) |
| Operation is in progress when the user closes the window | Cancel the operation, then clean up |

### 4.3. Implementation Guidance

- Ensure the `on_closing()` handler (or equivalent) explicitly calls the ExifTool shutdown method (e.g., `exiftool_helper.terminate()` or the module-level cleanup function in `core/exif.py`).
- Register an `atexit` handler as a fallback for ungraceful exits.
- If the ExifTool module exposes a `shutdown()` or `cleanup()` function, call it. If not, add one and wire it into the application lifecycle.
- After implementing the fix, verify by running the GUI, executing an operation that invokes ExifTool, closing the application, and confirming via the system process list (`tasklist` on Windows, `ps aux | grep exiftool` on Unix) that no orphaned ExifTool processes remain.

### 4.4. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/gui/app.py` | Application shutdown handler (`on_closing()` or equivalent) |
| `src/shruggie_indexer/core/exif.py` | ExifTool lifecycle management — ensure a `shutdown()` / `cleanup()` function exists and is callable |

### 4.5. Acceptance Criteria

- After closing the GUI, zero orphaned `exiftool` processes remain in the system process list.
- This holds true whether the user ran zero operations, one operation, or multiple operations during the session.
- This holds true whether the user closes the GUI while an operation is running or after all operations are complete.
- An `atexit` handler is registered as a safety net for abnormal termination.

---

## 5. ExifTool Warning Regression: Unknown File Types (Priority: Medium)

### 5.1. Problem Statement

Despite the fix implemented in `20260223-002-Updates.md` Section 3.3, WARNING-level log messages are still being emitted when ExifTool encounters files with unrecognized types (e.g., `.7z` archives). The expected behavior after that fix was:

- ExifTool returns valid JSON containing system-level metadata plus an `ExifTool:Error` informational field.
- The metadata is captured and filtered through the standard key exclusion pipeline.
- A log message is emitted at INFO level (not WARNING): *"ExifTool: unknown file type for \<filename\>; system metadata preserved."*
- The persistent ExifTool process is NOT reset.

If WARNING-level messages are still appearing, one or more of the following may be true:

- The fix from Section 3.3 was not fully implemented or was partially reverted.
- The fix handles the batch backend path (`pyexiftool`) but not the subprocess fallback path.
- The log-level adjustment from WARNING to INFO was missed.
- The persistent process reset logic was not fully removed for this case.

### 5.2. Required Investigation

The implementing agent must:

1. Search for all WARNING-level log calls in `src/shruggie_indexer/core/exif.py` and identify which ones fire for non-zero exit codes with valid output.
2. Verify that the `_recover_metadata_from_error()` function (or equivalent) is being invoked when ExifTool returns exit code 1 with valid JSON.
3. Verify that the recovered metadata is passed through `_filter_keys()` with the configured exclusion set.
4. Verify that the persistent ExifTool process is NOT reset when the error is a recoverable "Unknown file type" condition.
5. Verify that the subprocess fallback path applies the same recovery logic.

### 5.3. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/core/exif.py` | ExifTool error handling, metadata recovery, log levels, process reset logic |

### 5.4. Spec References

| Reference | Section |
|-----------|---------|
| EXIF and embedded metadata extraction | `shruggie-indexer-spec.md` §6.6 |
| ExifTool invocation strategy | `shruggie-indexer-spec.md` §17.5 |
| Prior fix specification | `20260223-002-Updates.md` §3.3 |

### 5.5. Acceptance Criteria

- Processing a `.7z` file (or any file where ExifTool reports `"Unknown file type"`) does NOT produce a WARNING-level log message.
- System-level metadata (file size, timestamps, attributes) is captured in the output `metadata` array for such files.
- An INFO-level log message is emitted confirming that system metadata was preserved despite the unknown file type.
- The persistent ExifTool process is not reset for this condition.
- The subprocess fallback path behaves identically to the batch backend path for this scenario.
- Existing unit tests in `tests/unit/test_exif.py` (`TestNonZeroExitMetadataRecovery`) continue to pass.
