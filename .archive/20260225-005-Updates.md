# shruggie-indexer — Pending Updates (2026-02-25, Batch 5)

- **Project:** `shruggie-indexer`
- **Repository:** [shruggietech/shruggie-indexer](https://github.com/shruggietech/shruggie-indexer)
- **Author:** William Thompson (ShruggieTech LLC)
- **Date:** 2026-02-25
- **Target Release:** Pre-v0.1.1 (GUI stabilization, continued)
- **Audience:** AI-first, Human-second
- **Predecessor:** This document follows `20260225-004-GUI-BugBrief-DiscoveryHang.md`. It assumes all items in that document (discovery hang, broken cancel, missing logging) have been resolved. The runtime log (`20260225-004-GUI-BugBrief-DiscoveryHang_Runtime.log`) from the successful post-fix run is the primary evidence file for the issues described here.

---

## Purpose

The discovery hang, cancel, and logging issues from Batch 4 are resolved. The GUI now completes a Meta Merge Delete operation against the test directory and produces a full debug log file. However, analysis of that log reveals two remaining issues: the file rename operation silently fails due to incorrect path construction, and several log messages use inappropriate severity levels that would hide operational failures from users at normal verbosity.

This document defines a single sprint to resolve both issues. All items target `src/shruggie_indexer/gui/app.py` and `src/shruggie_indexer/core/entry.py` (or whichever module orchestrates the post-processing rename phase).

### Implementation Ordering

1. **Section 1** (Log level corrections) — Quick severity reclassification. Execute first so that the rename investigation in Section 2 produces correctly-leveled diagnostic output.
2. **Section 2** (Rename path construction bug) — Root-cause the doubled directory path and fix it. Depends on Section 1 for proper diagnostic visibility.

---

## 1. Log Level Misclassifications (Priority: High)

### 1.1. Problem Statement

Several log messages in the runtime output use `DEBUG` severity for events that represent operational failures or significant fallback behavior. At the GUI's default verbosity of `WARNING` (Normal mode), these messages are invisible to the user — the operation appears to succeed when it has in fact silently failed.

The principle established in `20260225-004-GUI-BugBrief-DiscoveryHang.md` Issue 3 is: *the file handler always runs at DEBUG level, but the GUI panel handler's level is controlled by the Verbosity setting.* This means DEBUG messages are captured in the log file but are invisible in the GUI panel at Normal verbosity. Operational failures must be visible at Normal verbosity, which means they must be `WARNING` or higher.

### 1.2. Messages Requiring Reclassification

The following messages observed in the runtime log must be reclassified:

| Current level | Required level | Log message pattern | Rationale |
|---------------|----------------|---------------------|-----------|
| `DEBUG` | `WARNING` | `Path.rename() failed, falling back to shutil.move: {src} → {dst}` | A filesystem operation failed. The fallback is a recovery mechanism, not normal behavior. The user needs to know that the primary rename mechanism failed. |
| `DEBUG` | `WARNING` | `Inplace sidecar written to {path}` (when path contains `_meta.json_meta2.json` or `_meta2.json_meta2.json` — i.e., a sidecar-of-a-sidecar) | Writing a `_meta2.json` output for an existing `_meta.json` sidecar file is technically correct (every indexed file gets an in-place sidecar), but this naming pattern (`file_meta.json_meta2.json`) is confusing and may indicate that existing sidecar files are being indexed as standalone items rather than being associated with their parents. At minimum this should be `DEBUG` — but see the note below. |

**Note on sidecar-of-sidecar writes:** The log shows paths like `123.nfo_meta.json_meta2.json` and `FeedsExport.7z_meta2.json_meta2.json`. This is not a log-level issue alone — it may indicate a deeper problem where existing sidecar files (which were already present on disk before the operation) are being indexed as independent items rather than being recognized and excluded as sidecars of their parent files. This document does not request a fix for that behavior, but the implementing agent should note whether this is expected or anomalous during the Section 2 investigation.

### 1.3. Missing Log Messages

The rename operation does not log success or final failure. The log shows the attempt (`Path.rename() failed, falling back to shutil.move`) but never confirms whether the `shutil.move` fallback succeeded or failed. Add the following log messages to the rename code path:

| Level | Condition | Message pattern |
|-------|-----------|-----------------|
| `INFO` | Rename succeeded via `Path.rename()` | `File renamed: {old_name} → {new_name}` |
| `INFO` | Rename succeeded via `shutil.move` fallback | `File renamed (fallback): {old_name} → {new_name}` |
| `ERROR` | Both `Path.rename()` and `shutil.move` failed | `File rename FAILED: {src} → {dst}: {exception}` |
| `INFO` | Dry-run mode | `Dry run — would rename: {old_name} → {new_name}` |

### 1.4. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/core/rename.py` | `rename_item()` — primary location for rename log messages |
| `src/shruggie_indexer/core/entry.py` | Orchestrator — may contain the `Path.rename() failed` fallback log if the fallback logic lives here rather than in `rename.py` |

### 1.5. Acceptance Criteria

- `Path.rename()` failure with `shutil.move` fallback is logged at `WARNING`.
- Successful renames are logged at `INFO` (distinguishing primary vs. fallback path).
- Failed renames (both mechanisms) are logged at `ERROR` with the exception message.
- Dry-run renames are logged at `INFO`.
- No rename attempt completes without a terminal log message confirming success or failure.

---

## 2. Rename Operation: Incorrect Path Construction (Priority: Critical)

### 2.1. Problem Statement

The rename operation silently fails for all files. No files are renamed on disk despite the "Rename files" checkbox being enabled and the operation completing without errors.

### 2.2. Evidence from Runtime Log

Lines 194–199 of the runtime log show all six rename attempts for files in the root target directory:

```
06:04:32  DEBUG  Path.rename() failed, falling back to shutil.move: A:\Code\shruggie-indexer-testing\data\data\123.nfo → A:\Code\shruggie-indexer-testing\data\data\y65830E2E332651F6235D52A8553E1864.nfo
06:04:32  DEBUG  Path.rename() failed, falling back to shutil.move: A:\Code\shruggie-indexer-testing\data\data\123.nfo_meta.json → A:\Code\shruggie-indexer-testing\data\data\y946BB2ACFA9079B53A094F8541402B3A.json
06:04:32  DEBUG  Path.rename() failed, falling back to shutil.move: A:\Code\shruggie-indexer-testing\data\data\123.nfo_meta2.json → A:\Code\shruggie-indexer-testing\data\data\yA752E6AA0DF6CA000AA4062D8C96B4C3.json
06:04:32  DEBUG  Path.rename() failed, falling back to shutil.move: A:\Code\shruggie-indexer-testing\data\data\123.txt → A:\Code\shruggie-indexer-testing\data\data\y9F402849933BF3B57FD50F9F0BA13BF4.txt
06:04:32  DEBUG  Path.rename() failed, falling back to shutil.move: A:\Code\shruggie-indexer-testing\data\data\123.txt_meta.json → A:\Code\shruggie-indexer-testing\data\data\y909AB3E450A84B00D65FF4B8A4054932.json
06:04:32  DEBUG  Path.rename() failed, falling back to shutil.move: A:\Code\shruggie-indexer-testing\data\data\123.txt_meta2.json → A:\Code\shruggie-indexer-testing\data\data\y7D325D9043395FF0767C0723BA73D246.json
```

### 2.3. Root Cause: Doubled Directory Name in Path

The source and destination paths both contain `\data\data\` — the target directory name (`data`) is duplicated. The actual file is at:

```
A:\Code\shruggie-indexer-testing\data\123.nfo
```

But the rename is attempting to operate on:

```
A:\Code\shruggie-indexer-testing\data\data\123.nfo
```

This path does not exist, so `Path.rename()` raises an `OSError` (file not found). The `shutil.move` fallback also fails for the same reason (the source file does not exist at the constructed path). Both failures are swallowed, and no file is renamed.

### 2.4. Likely Location of the Bug

The path construction error is upstream of `rename_item()` — the `rename_item()` function receives pre-constructed paths and operates on them. The bug is in whichever code assembles the `original_path` argument before passing it to `rename_item()`.

Investigate the following code path (in order of likelihood):

1. **The rename dispatch loop in the post-processing phase** (`entry.py` or `app.py`). After all items are indexed, the rename phase iterates over completed entries and constructs the path to rename. If this loop uses `target_root / entry.name.text` or `target_root / relative_path` to reconstruct the original path, and if `target_root` is the parent of the target directory rather than the target directory itself (or vice versa), the directory name will be doubled.

2. **The `file_system.relative` field** in the `IndexEntry`. If the relative path stored in the entry already includes the target directory's leaf name (e.g., `data/123.nfo`), and the rename loop joins this to the full target path (`A:\...\data`), the result is `A:\...\data\data\123.nfo`.

3. **`build_directory_entry()` or the recursive traversal** passing the wrong root reference to the post-processing rename phase.

The implementing agent must trace the exact code path from the completion of indexing through to the `rename_item()` call and identify where the extra directory segment is introduced.

### 2.5. Secondary Issue: Missing Subdirectory Renames

The runtime log shows rename attempts **only** for the 6 files in the root `data/` directory. No rename attempts appear for files in subdirectories (`images/slippers.gif`, `not-empty/FeedsExport.7z`, `not-empty/pdf/pdf/[a] {b} (c)_1.pdf`, etc.). This could mean:

- **(a)** The rename phase only operates on top-level items and does not recurse into subdirectories, OR
- **(b)** The rename phase iterates all items but the path construction failure on the root-level items causes the loop to abort early (e.g., an unhandled exception breaks the loop), OR
- **(c)** The rename phase runs per-directory during recursive traversal, and the path bug affects all levels (but subdirectory rename attempts are not logged because the loop structure is different).

The implementing agent must determine which case applies and ensure that the fix produces rename attempts for all files at all directory depths when the operation is recursive.

### 2.6. Affected Files

| File | Role |
|------|------|
| `src/shruggie_indexer/core/entry.py` | `build_directory_entry()` — likely location of the rename dispatch loop and path construction |
| `src/shruggie_indexer/core/rename.py` | `rename_item()` — receives paths, performs the rename. Not likely the source of the bug, but verify the path it receives. |
| `src/shruggie_indexer/core/paths.py` | `build_storage_path()` — constructs the target (destination) path. The destination path also has the doubled directory, so this function may be receiving a bad `item_path` argument. |
| `src/shruggie_indexer/gui/app.py` | GUI orchestrator — may be constructing paths before passing them to the backend |

### 2.7. Fix Requirements

- The rename operation must use the correct absolute path for each file, as originally resolved during the discovery/indexing phase. The path should come from the `IndexEntry`'s filesystem fields or from the original `Path` object used during indexing — it should NOT be reconstructed from components.
- After fixing the path construction, all files in the test directory (at all depth levels) must be renamed to their `storage_name` values.
- Directories are not renamed (this matches spec §6.10 and the original MakeIndex behavior).
- The `shutil.move` fallback path should remain as a safety net but should not be exercised during normal same-directory renames.

### 2.8. Acceptance Criteria

- Running Meta Merge Delete with "Rename files" enabled and "Dry run" disabled against the test directory results in all non-directory files being renamed to their `storage_name` values on disk.
- The runtime log shows `INFO`-level "File renamed" messages for every renamed file.
- No "Path.rename() failed" warnings appear for same-directory renames.
- Renamed files exist at their new paths with the correct content (byte-identical to originals).
- In-place `_meta2.json` sidecar files are written alongside each renamed file, containing the original filename in `name.text`.
- The operation is reversible using the sidecar manifests (the original name is preserved in the `IndexEntry`).
- Files in subdirectories (all depth levels) are renamed, not just root-level files.

---

## Reference: Test Directory Structure

The test directory is unchanged from `20260225-004-GUI-BugBrief-DiscoveryHang.md`. See that document's "What the Test Case Contains" section for the full tree listing. The key parameters are: 38 files, 10 directories, max depth 4, located at `A:\Code\shruggie-indexer-testing\data`.

---

## Reference: Runtime Log

The complete runtime log from the post-fix run is attached as `20260225-004-GUI-BugBrief-DiscoveryHang_Runtime.log`. Lines 194–199 contain the rename failures. Lines 200–247 contain the in-place sidecar writes.
