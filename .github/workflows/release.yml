# -------------------------------------------------------------------
# release.yml — GitHub Actions release pipeline for shruggie-indexer
# -------------------------------------------------------------------
#
# Triggers on version tag pushes (v*). Builds CLI and GUI standalone
# executables on 3 platforms via PyInstaller, runs the test suite on
# each platform, renames artifacts with version and platform tags,
# and creates a GitHub Release with all 6 artifacts attached.
#
# See: shruggie-indexer-spec.md §13.5.1
# -------------------------------------------------------------------

name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform_suffix }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: windows-latest
            platform_suffix: windows-x64
            cli_name: shruggie-indexer.exe
            gui_name: shruggie-indexer-gui.exe
            cli_ext: .exe
            gui_ext: .exe
          - os: ubuntu-latest
            platform_suffix: linux-x64
            cli_name: shruggie-indexer
            gui_name: shruggie-indexer-gui
            cli_ext: ""
            gui_ext: ""
          - os: macos-latest
            platform_suffix: macos-arm64
            cli_name: shruggie-indexer
            gui_name: shruggie-indexer-gui
            cli_ext: ""
            gui_ext: ""

    steps:
      # ------------------------------------------------------------------
      # Stage 1 — Checkout and environment setup
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Create virtual environment and install dependencies
        shell: bash
        run: |
          python -m venv .venv
          source .venv/bin/activate || . .venv/Scripts/activate
          python -m pip install --upgrade pip
          pip install -e ".[gui,dev]"
          pip install pyinstaller

      # ------------------------------------------------------------------
      # Stage 2 — Test
      # ------------------------------------------------------------------
      - name: Run test suite
        shell: bash
        run: |
          source .venv/bin/activate || . .venv/Scripts/activate
          pytest tests/ -m "not requires_exiftool"

      # ------------------------------------------------------------------
      # Stage 3 — Build
      # ------------------------------------------------------------------
      - name: Build executables (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          source .venv/bin/activate
          bash scripts/build.sh

      - name: Build executables (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          .venv/Scripts/Activate.ps1
          & scripts/build.ps1

      # ------------------------------------------------------------------
      # Stage 4 — Rename artifacts
      # ------------------------------------------------------------------
      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Rename CLI artifact
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SUFFIX="${{ matrix.platform_suffix }}"
          EXT="${{ matrix.cli_ext }}"
          SRC="dist/${{ matrix.cli_name }}"
          DST="dist/shruggie-indexer-${VERSION}-${SUFFIX}${EXT}"
          mv "$SRC" "$DST"
          echo "Renamed: $SRC -> $DST"

      - name: Rename GUI artifact
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SUFFIX="${{ matrix.platform_suffix }}"
          EXT="${{ matrix.gui_ext }}"
          SRC="dist/${{ matrix.gui_name }}"
          DST="dist/shruggie-indexer-gui-${VERSION}-${SUFFIX}${EXT}"
          mv "$SRC" "$DST"
          echo "Renamed: $SRC -> $DST"

      # ------------------------------------------------------------------
      # Stage 5 — Upload artifacts
      # ------------------------------------------------------------------
      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: shruggie-indexer-${{ steps.version.outputs.version }}-${{ matrix.platform_suffix }}
          path: dist/shruggie-indexer-${{ steps.version.outputs.version }}-${{ matrix.platform_suffix }}${{ matrix.cli_ext }}
          if-no-files-found: error

      - name: Upload GUI artifact
        uses: actions/upload-artifact@v4
        with:
          name: shruggie-indexer-gui-${{ steps.version.outputs.version }}-${{ matrix.platform_suffix }}
          path: dist/shruggie-indexer-gui-${{ steps.version.outputs.version }}-${{ matrix.platform_suffix }}${{ matrix.gui_ext }}
          if-no-files-found: error

  # --------------------------------------------------------------------
  # Stage 6 — Create GitHub Release
  # --------------------------------------------------------------------
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts/
          merge-multiple: true

      - name: List downloaded artifacts
        run: find release-artifacts/ -type f | sort

      - name: Generate release notes from changelog
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          python - <<'PY'
          import pathlib

          version = "${{ steps.version.outputs.version }}"
          changelog_path = pathlib.Path("CHANGELOG.md")
          output_path = pathlib.Path("release-artifacts/RELEASE_BODY.md")

          changelog_section = ""
          if changelog_path.exists():
              lines = changelog_path.read_text(encoding="utf-8").splitlines()
              start = None
              for idx, line in enumerate(lines):
                  if line.strip().startswith(f"## [{version}]"):
                      start = idx
                      break
              if start is not None:
                  end = len(lines)
                  for idx in range(start + 1, len(lines)):
                      if lines[idx].strip().startswith("## ["):
                          end = idx
                          break
                  changelog_section = "\n".join(lines[start:end]).strip()

          if not changelog_section:
              changelog_section = (
                  f"## [{version}]\n\n"
                  "No formal changelog entry found for this version in `CHANGELOG.md`."
              )

            body = (
              f"## shruggie-indexer v{version}\n\n"
              "### Changelog\n\n"
              f"{changelog_section}\n\n"
              "### Downloads\n\n"
              "| Platform | CLI | GUI |\n"
              "|----------|-----|-----|\n"
              f"| Windows x64 | `shruggie-indexer-{version}-windows-x64.exe` | `shruggie-indexer-gui-{version}-windows-x64.exe` |\n"
              f"| Linux x64 | `shruggie-indexer-{version}-linux-x64` | `shruggie-indexer-gui-{version}-linux-x64` |\n"
              f"| macOS ARM64 | `shruggie-indexer-{version}-macos-arm64` | `shruggie-indexer-gui-{version}-macos-arm64` |\n\n"
              "### Installation\n\n"
              "Download the appropriate executable for your platform and run it directly. No installation required.\n\n"
              "Linux/macOS users: make the file executable with `chmod +x <filename>` before running.\n\n"
              "**Note:** Metadata extraction requires [ExifTool](https://exiftool.org/) installed separately and available on PATH.\n"
            )

          output_path.write_text(body, encoding="utf-8")
          PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: shruggie-indexer v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') }}
          files: release-artifacts/*
          body_path: release-artifacts/RELEASE_BODY.md
